<?php
/**
 * HOT ITEM ëª¨ë“ˆ
 * ì¸ê¸° ìƒí’ˆì„ í‘œì‹œí•˜ê³  êµ¬ë§¤ ê¸°ëŠ¥ì„ ì œê³µ
 */

require_once 'config.php';

/**
 * HOT ITEM ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
 */
function getHotItems($limit = 6) {
    global $pdo;
    $limit = max(1, (int)$limit);
    try {
        if (!$pdo) return [];

        $stmt = $pdo->prepare("
            SELECT id, title, product_name, category, description, content,
                   original_price, sale_price, image_path,
                   image_path_1, image_path_2, image_path_3, image_path_4,
                   badge_type, icon, gradient, is_active,
                   special_notes, contact_phone, whatsapp,
                   upload_date, deadline, created_at
            FROM hot_items
            WHERE is_active = 1
            ORDER BY created_at DESC
            LIMIT {$limit}
        ");
        $stmt->execute();
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    } catch (PDOException $e) {
        error_log("HOT ITEM ì¡°íšŒ ì˜¤ë¥˜: " . $e->getMessage());
        return [];
    }
}

/**
 * íŠ¹ì • HOT ITEM ìƒí’ˆ ì¡°íšŒ
 */
function getHotItem($item_id) {
    global $pdo;
    try {
        if (!$pdo) return null;

        $stmt = $pdo->prepare("
            SELECT * FROM hot_items
            WHERE id = ? AND is_active = 1
        ");
        $stmt->execute([$item_id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    } catch (PDOException $e) {
        error_log("HOT ITEM ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜: " . $e->getMessage());
        return null;
    }
}

/**
 * HOT ITEM ìƒí’ˆì˜ í• ì¸ìœ¨ ê³„ì‚°
 */
function getDiscountRate($original_price, $sale_price) {
    if ($original_price <= 0 || $sale_price >= $original_price) {
        return 0;
    }
    return round((($original_price - $sale_price) / $original_price) * 100);
}

/**
 * HOT ITEM ë±ƒì§€ íƒ€ì…ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ë°˜í™˜
 */
function getBadgeClass($badge_type) {
    $classes = [
        'hot' => 'badge-hot',
        'new' => 'badge-new',
        'sale' => 'badge-sale',
        'best' => 'badge-best',
        'limited' => 'badge-limited'
    ];
    return $classes[strtolower($badge_type)] ?? 'badge-default';
}

/**
 * HOT ITEM ì„¹ì…˜ HTML ìƒì„±
 */
function displayHotItemSection($limit = 6) {
    $items = getHotItems($limit);

    if (empty($items)) {
        return '<div class="no-items">ë“±ë¡ëœ HOT ITEMì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    ob_start();
    ?>
    <!-- HOT ITEM ì„¹ì…˜ -->
    <section class="hotitem-section" style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 2rem 0; border: 1px solid #e5e7eb;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <!-- ì„¹ì…˜ í—¤ë” -->
            <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #2563eb; text-align: center;">
                <h2 style="color: #2563eb; font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 1rem;">
                    <i class="fas fa-fire" style="color: #f59e0b;"></i>
                    HOT ITEM
                    <span style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        ì¸ê¸°ìƒí’ˆ
                    </span>
                </h2>
                <p style="color: #6b7280; font-size: 1.1rem; margin: 0;">ê³ ê°ë‹˜ì„ ìœ„í•œ íŠ¹ë³„ í• ì¸ ìƒí’ˆ</p>
            </div>

            <!-- ìƒí’ˆ ê·¸ë¦¬ë“œ -->
            <div class="hotitem-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                <?php foreach ($items as $item): ?>
                    <?php
                    $discount_rate = getDiscountRate($item['original_price'], $item['sale_price']);
                    $badge_class = getBadgeClass($item['badge_type']);
                    // ì‚¬ìš© ê°€ëŠ¥í•œ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì„ íƒ
                    $display_image = $item['image_path'] ?? $item['image_path_1'] ?? $item['image_path_2'] ?? $item['image_path_3'] ?? $item['image_path_4'] ?? null;
                    // ìƒí’ˆëª… ì„ íƒ (product_nameì´ ìˆìœ¼ë©´ ìš°ì„ , ì—†ìœ¼ë©´ title)
                    $display_title = !empty($item['product_name']) ? $item['product_name'] : $item['title'];
                    ?>
                    <div class="hotitem-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;">
                        <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                        <div class="hotitem-image" style="height: 200px; background: #f8fafc; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            <?php if (!empty($display_image)): ?>
                                <img src="<?= htmlspecialchars($display_image) ?>"
                                     alt="<?= htmlspecialchars($display_title) ?>"
                                     style="width: 100%; height: 100%; object-fit: cover;">
                            <?php else: ?>
                                <div style="color: #9ca3af; font-size: 3rem;">
                                    <i class="fas fa-box"></i>
                                </div>
                            <?php endif; ?>
                        </div>

                        <!-- ìƒí’ˆ ì •ë³´ -->
                        <div class="hotitem-content" style="padding: 1.5rem;">
                            <!-- ì¹´í…Œê³ ë¦¬ -->
                            <?php if (!empty($item['category'])): ?>
                                <div style="color: #6b7280; font-size: 0.8rem; margin-bottom: 0.5rem;">
                                    <?= htmlspecialchars($item['category']) ?>
                                </div>
                            <?php endif; ?>

                            <!-- ë±ƒì§€ -->
                            <?php if (!empty($item['badge_type'])): ?>
                                <div class="badge <?= $badge_class ?>" style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; color: white; margin-bottom: 0.75rem;">
                                    <?php if ($item['badge_type'] === 'hot'): ?>
                                        ğŸ”¥ HOT
                                    <?php elseif ($item['badge_type'] === 'new'): ?>
                                        ğŸ†• NEW
                                    <?php elseif ($item['badge_type'] === 'sale'): ?>
                                        ğŸ’° SALE
                                    <?php elseif ($item['badge_type'] === 'best'): ?>
                                        â­ BEST
                                    <?php elseif ($item['badge_type'] === 'limited'): ?>
                                        â° LIMITED
                                    <?php else: ?>
                                        <?= strtoupper($item['badge_type']) ?>
                                    <?php endif; ?>
                                </div>
                            <?php endif; ?>

                            <!-- ìƒí’ˆëª… -->
                            <h3 style="color: #1f2937; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; line-height: 1.4;">
                                <?= htmlspecialchars($display_title) ?>
                            </h3>

                            <!-- ìƒí’ˆ ì„¤ëª… -->
                            <?php
                            $description = !empty($item['content']) ? $item['content'] : (!empty($item['description']) ? $item['description'] : '');
                            ?>
                            <?php if (!empty($description)): ?>
                                <p style="color: #6b7280; font-size: 0.9rem; line-height: 1.5; margin-bottom: 1rem;">
                                    <?= htmlspecialchars(substr($description, 0, 60)) ?><?= strlen($description) > 60 ? '...' : '' ?>
                                </p>
                            <?php endif; ?>

                            <!-- ê°€ê²© ì •ë³´ -->
                            <div class="price-section" style="margin-bottom: 1rem;">
                                <?php if ($item['original_price'] > $item['sale_price']): ?>
                                    <div style="text-decoration: line-through; color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.25rem;">
                                        ì •ê°€: $<?= number_format($item['original_price']) ?>
                                    </div>
                                <?php endif; ?>

                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: #dc2626; font-size: 1.5rem; font-weight: 700;">
                                        $<?= number_format($item['sale_price']) ?>
                                    </span>
                                    <?php if ($discount_rate > 0): ?>
                                        <span style="background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                            <?= $discount_rate ?>% OFF
                                        </span>
                                    <?php endif; ?>
                                </div>
                            </div>

                            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                            <div style="display: flex; gap: 0.5rem;">
                                <a href="../tradecar/inquiry.php?item_id=<?= $item['id'] ?>"
                                   style="flex: 1; padding: 0.75rem 1rem; background: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.9rem; text-align: center; transition: background 0.2s;">
                                    <i class="fas fa-shopping-cart"></i> êµ¬ë§¤í•˜ê¸°
                                </a>
                                <a href="../tradecar/inquiry.php?item_id=<?= $item['id'] ?>"
                                   style="padding: 0.75rem 1rem; background: #6b7280; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.9rem; transition: background 0.2s;">
                                    <i class="fas fa-question-circle"></i> ë¬¸ì˜
                                </a>
                            </div>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>

            <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
            <div style="text-align: center; margin-top: 2rem;">
                <a href="../tradecar/index.php"
                   style="padding: 0.75rem 2rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: 600; font-size: 1rem; transition: transform 0.2s, box-shadow 0.2s; display: inline-block;">
                    <i class="fas fa-eye"></i> ëª¨ë“  ìƒí’ˆ ë³´ê¸°
                </a>
            </div>
        </div>
    </section>

    <style>
        /* HOT ITEM ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ */
        .hotitem-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .badge-hot {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .badge-new {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .badge-sale {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .badge-best {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .badge-limited {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .badge-default {
            background: #6b7280;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .hotitem-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }

            .hotitem-section {
                padding: 1.5rem !important;
                margin: 1rem 0 !important;
            }

            .hotitem-content {
                padding: 1rem !important;
            }

            .main-title-section h1 {
                font-size: 1.5rem !important;
            }
        }
    </style>
    <?php
    return ob_get_clean();
}

/**
 * HOT ITEM í†µê³„ ì •ë³´ ì¡°íšŒ
 */
function getHotItemStats() {
    global $pdo;
    try {
        if (!$pdo) return ['total' => 0, 'active' => 0, 'categories' => 0];

        $stmt = $pdo->query("SELECT COUNT(*) as total FROM hot_items");
        $total = $stmt->fetchColumn();

        $stmt = $pdo->query("SELECT COUNT(*) as active FROM hot_items WHERE is_active = 1");
        $active = $stmt->fetchColumn();

        $stmt = $pdo->query("SELECT COUNT(DISTINCT category) as categories FROM hot_items WHERE category IS NOT NULL AND category != ''");
        $categories = $stmt->fetchColumn();

        return [
            'total' => $total,
            'active' => $active,
            'categories' => $categories
        ];
    } catch (PDOException $e) {
        error_log("HOT ITEM í†µê³„ ì¡°íšŒ ì˜¤ë¥˜: " . $e->getMessage());
        return ['total' => 0, 'active' => 0, 'categories' => 0];
    }
}

/**
 * ì¸ê¸° ìƒí’ˆ ì¶”ì²œ (êµ¬ë§¤ ë§ì€ ìˆœ)
 */
function getPopularHotItems($limit = 4) {
    global $pdo;
    $limit = max(1, (int)$limit);
    try {
        if (!$pdo) return [];

        // êµ¬ë§¤ í†µê³„ê°€ ìˆëŠ” í…Œì´ë¸”ì´ ìˆë‹¤ë©´ ì¡°íšŒ, ì—†ìœ¼ë©´ ìµœì‹  ìƒí’ˆ ë°˜í™˜
        $stmt = $pdo->prepare("
            SELECT h.*, COALESCE(p.purchase_count, 0) as purchase_count
            FROM hot_items h
            LEFT JOIN (
                SELECT item_id, COUNT(*) as purchase_count
                FROM hotitem_purchases
                GROUP BY item_id
            ) p ON h.id = p.item_id
            WHERE h.is_active = 1
            ORDER BY COALESCE(p.purchase_count, 0) DESC, h.created_at DESC
            LIMIT {$limit}
        ");
        $stmt->execute();
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    } catch (PDOException $e) {
        error_log("ì¸ê¸° HOT ITEM ì¡°íšŒ ì˜¤ë¥˜: " . $e->getMessage());
        return [];
    }
}

/**
 * ë§ˆì´í˜ì´ì§€ìš© HOT ITEM ì„¹ì…˜ (ê°„ë‹¨ ë²„ì „)
 */
function displayHotItemSectionSimple($limit = 3) {
    $items = getHotItems($limit);
    $stats = getHotItemStats();

    ob_start();
    ?>
    <!-- HOT ITEM ê°„ë‹¨ ì„¹ì…˜ -->
    <div class="hotitem-simple-section" style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 1rem 0; border: 1px solid #e5e7eb;">
        <div style="margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #f59e0b;">
            <h3 style="color: #1f2937; font-size: 1.2rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-fire" style="color: #f59e0b;"></i>
                HOT ITEM ì¶”ì²œ
                <span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; margin-left: auto;">
                    <?= $stats['active'] ?>ê°œ ìƒí’ˆ
                </span>
            </h3>
        </div>

        <?php if (empty($items)): ?>
            <!-- ë°ì´í„° ì—†ì„ ë•Œ ë©”ì‹œì§€ -->
            <div style="text-align: center; padding: 2rem; background: #f9fafb; border-radius: 8px; color: #6b7280;">
                <i class="fas fa-fire" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; color: #f59e0b;"></i>
                <h4 style="margin-bottom: 0.5rem; color: #374151;">HOT ITEMì´ ì—†ìŠµë‹ˆë‹¤</h4>
                <p style="margin: 0; font-size: 0.9rem;">ê³§ ì¸ê¸° ìƒí’ˆì´ ë“±ë¡ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>
        <?php else: ?>
            <div class="hotitem-simple-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <?php foreach ($items as $item): ?>
                    <?php
                    $discount_rate = getDiscountRate($item['original_price'], $item['sale_price']);
                    $display_image = $item['image_path'] ?? $item['image_path_1'] ?? $item['image_path_2'] ?? $item['image_path_3'] ?? $item['image_path_4'] ?? null;
                    $display_title = !empty($item['product_name']) ? $item['product_name'] : $item['title'];
                    ?>
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; transition: transform 0.2s;">
                        <div style="text-align: center;">
                            <?php if (!empty($display_image)): ?>
                                <img src="<?= htmlspecialchars($display_image) ?>"
                                     alt="<?= htmlspecialchars($display_title) ?>"
                                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 0.75rem;">
                            <?php else: ?>
                                <div style="width: 80px; height: 80px; background: #e5e7eb; border-radius: 8px; margin: 0 auto 0.75rem; display: flex; align-items: center; justify-content: center; color: #9ca3af;">
                                    <i class="fas fa-box"></i>
                                </div>
                            <?php endif; ?>

                            <h4 style="color: #1f2937; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem;">
                                <?= htmlspecialchars($display_title) ?>
                            </h4>

                            <div style="color: #dc2626; font-weight: 600; font-size: 1.1rem; margin-bottom: 0.25rem;">
                                $<?= number_format($item['sale_price']) ?>
                            </div>

                            <?php if ($discount_rate > 0): ?>
                                <div style="color: #059669; font-size: 0.8rem; font-weight: 500;">
                                    <?= $discount_rate ?>% í• ì¸
                                </div>
                            <?php endif; ?>

                            <a href="../tradecar/inquiry.php?item_id=<?= $item['id'] ?>"
                               style="display: inline-block; padding: 0.5rem 1rem; background: #2563eb; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin-top: 0.5rem; transition: background 0.2s;">
                                êµ¬ë§¤í•˜ê¸°
                            </a>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>

            <div style="text-align: center; margin-top: 1rem;">
                <a href="../tradecar/index.php"
                   style="color: #2563eb; text-decoration: none; font-weight: 500; font-size: 0.9rem;">
                    <i class="fas fa-arrow-right"></i> View all trade cars
                </a>
            </div>
        <?php endif; ?>
    </div>

    <style>
        /* HOT ITEM ê°„ë‹¨ ë²„ì „ ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .hotitem-simple-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
    <?php
    return ob_get_clean();
}
?>
