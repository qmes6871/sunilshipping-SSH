<?php
/**
 * 고객 서류 업로드 모듈
 * 고객이 컨테이너별 서류를 직접 등록할 수 있는 기능
 */

/**
 * 고객의 컨테이너 목록 조회
 */
function getCustomerContainerList($customer_id) {
    global $pdo;
    try {
        if (!$pdo) return [];

        // container_tracking 테이블이 존재하는지 확인
        try {
            $pdo->query("DESCRIBE container_tracking");
            $stmt = $pdo->prepare("
                SELECT ct_id, cntr_no, buyer, port_1, port_2, status,
                       DATE_FORMAT(etd, '%Y-%m-%d') as etd,
                       DATE_FORMAT(eta, '%Y-%m-%d') as eta
                FROM container_tracking
                WHERE customer_id = ?
                ORDER BY reg_date DESC
            ");
            $stmt->execute([$customer_id]);
            return $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (Exception $e) {
            // container_tracking 테이블이 없으면 빈 배열 반환
            return [];
        }
    } catch (PDOException $e) {
        error_log("컨테이너 목록 조회 오류: " . $e->getMessage());
        return [];
    }
}

/**
 * 고객이 업로드한 서류 목록 조회
 */
function getCustomerUploadedDocuments($customer_id, $ct_id = null) {
    global $pdo;
    try {
        if (!$pdo) return [];
        // 현재 테이블 구조에 맞는 SELECT 쿼리 (실제 컬럼들만 사용)
        $sql = "SELECT d.doc_id, d.customer_id, d.file_name, d.file_path, d.file_size, d.original_name,
                       DATE_FORMAT(d.upload_date, '%Y-%m-%d %H:%i') as upload_date
                FROM customer_documents d
                WHERE d.customer_id = ?";

        $params = [$customer_id];
        // ct_id 필터는 현재 테이블에 ct_id 컬럼이 없으므로 무시 (나중에 추가하면 활성화 가능)

        $sql .= " ORDER BY d.upload_date DESC";
        $stmt = $pdo->prepare($sql);
        $stmt->execute($params);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    } catch (PDOException $e) {
        error_log("서류 목록 조회 오류: " . $e->getMessage());
        return [];
    }
}

/**
 * 서류 업로드 처리 - 컨테이너, 서류 타입, 메모 지원
 */
function uploadCustomerDocument($customer_id, $file, $ct_id = null, $doc_type = null, $memo = null) {
    global $pdo;
    try {
        // PDO 연결 확인
        if (!$pdo) {
            return ['success' => false, 'message' => 'DB 연결 오류'];
        }

        // 파일 에러 확인
        if (isset($file['error']) && $file['error'] !== UPLOAD_ERR_OK) {
            $error_messages = [
                UPLOAD_ERR_INI_SIZE => '파일 크기가 서버 설정을 초과했습니다.',
                UPLOAD_ERR_FORM_SIZE => '파일 크기가 폼 설정을 초과했습니다.',
                UPLOAD_ERR_PARTIAL => '파일이 부분적으로만 업로드되었습니다.',
                UPLOAD_ERR_NO_FILE => '파일이 업로드되지 않았습니다.',
                UPLOAD_ERR_NO_TMP_DIR => '임시 폴더가 없습니다.',
                UPLOAD_ERR_CANT_WRITE => '디스크에 쓸 수 없습니다.',
                UPLOAD_ERR_EXTENSION => 'PHP 확장에 의해 중단되었습니다.'
            ];
            $error_msg = $error_messages[$file['error']] ?? '알 수 없는 오류가 발생했습니다.';
            return ['success' => false, 'message' => $error_msg];
        }

        $allowed_extensions = ['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx', 'xls', 'xlsx'];
        $max_file_size = 10 * 1024 * 1024;
        $file_ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));

        if (!in_array($file_ext, $allowed_extensions)) {
            return ['success' => false, 'message' => '허용되지 않는 파일 형식입니다.'];
        }
        if ($file['size'] > $max_file_size) {
            return ['success' => false, 'message' => '파일 크기가 너무 큽니다. (최대 10MB)'];
        }

        $upload_dir = __DIR__ . '/uploads/customer_documents/' . $customer_id . '/';
        if (!file_exists($upload_dir)) {
            if (!mkdir($upload_dir, 0755, true)) {
                return ['success' => false, 'message' => '업로드 폴더를 생성할 수 없습니다.'];
            }
        }

        $file_name = date('YmdHis') . '_' . uniqid() . '.' . $file_ext;
        $file_path = $upload_dir . $file_name;

        if (!move_uploaded_file($file['tmp_name'], $file_path)) {
            return ['success' => false, 'message' => '파일 업로드에 실패했습니다.'];
        }

        // 데이터베이스에 저장
        try {
            $relative_path = 'uploads/customer_documents/' . $customer_id . '/' . $file_name;

            // 현재 테이블 구조에 맞는 INSERT 쿼리 (실제 컬럼들만 사용)
            $sql = "INSERT INTO customer_documents (customer_id, file_name, file_path, file_size, original_name, upload_date)
                    VALUES (?, ?, ?, ?, ?, ?)";

            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                $customer_id,
                $file_name,
                $relative_path,
                $file['size'],
                $file['name'],
                date('Y-m-d H:i:s') // upload_date는 datetime 타입이므로 PHP에서 포맷팅
            ]);

            return ['success' => true, 'message' => '서류가 성공적으로 업로드되었습니다.', 'doc_id' => $pdo->lastInsertId()];
        } catch (PDOException $e) {
            // DB 저장 실패 시 업로드된 파일 삭제
            if (file_exists($file_path)) {
                unlink($file_path);
            }
            throw $e;
        }
    } catch (PDOException $e) {
        $error_msg = "DB 오류: " . $e->getMessage();
        error_log("서류 업로드 DB 오류: " . $e->getMessage());
        error_log("SQL State: " . $e->getCode());
        return ['success' => false, 'message' => $error_msg];
    } catch (Exception $e) {
        $error_msg = "오류: " . $e->getMessage();
        error_log("서류 업로드 오류: " . $e->getMessage());
        return ['success' => false, 'message' => $error_msg];
    }
}

/**
 * 서류 삭제
 */
function deleteCustomerDocument($customer_id, $doc_id) {
    global $pdo;
    try {
        if (!$pdo) return ['success' => false, 'message' => 'DB 연결 오류'];

        // 테이블 구조 확인
        try {
            $columns = $pdo->query("DESCRIBE customer_documents")->fetchAll(PDO::FETCH_COLUMN, 0);
        } catch (Exception $e) {
            return ['success' => false, 'message' => 'customer_documents 테이블이 존재하지 않습니다.'];
        }

        // 필요한 필드 확인
        $has_file_path = in_array('file_path', $columns);

        // 파일 경로 조회 (file_path 컬럼이 있으면)
        if ($has_file_path) {
            $stmt = $pdo->prepare("SELECT file_path FROM customer_documents WHERE doc_id = ? AND customer_id = ?");
            $stmt->execute([$doc_id, $customer_id]);
            $doc = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$doc) return ['success' => false, 'message' => '서류를 찾을 수 없거나 권한이 없습니다.'];
            $file_path = __DIR__ . '/' . $doc['file_path'];
            if (file_exists($file_path)) unlink($file_path);
        } else {
            // file_path 컬럼이 없으면 일단 권한만 확인
            $stmt = $pdo->prepare("SELECT doc_id FROM customer_documents WHERE doc_id = ? AND customer_id = ?");
            $stmt->execute([$doc_id, $customer_id]);
            if (!$stmt->fetch()) return ['success' => false, 'message' => '서류를 찾을 수 없거나 권한이 없습니다.'];
        }

        // 서류 삭제
        $stmt = $pdo->prepare("DELETE FROM customer_documents WHERE doc_id = ? AND customer_id = ?");
        $stmt->execute([$doc_id, $customer_id]);
        return ['success' => true, 'message' => '서류가 삭제되었습니다.'];
    } catch (PDOException $e) {
        error_log("서류 삭제 오류: " . $e->getMessage());
        return ['success' => false, 'message' => '서류 삭제 중 오류가 발생했습니다.'];
    }
}

/**
 * 서류 타입 옵션 반환
 */
function getDocumentTypeOptions() {
    return [
        'invoice' => '인보이스 (Invoice)',
        'bl' => '선하증권 (B/L)',
        'packing_list' => '포장명세서 (Packing List)',
        'certificate' => '원산지증명서 (Certificate of Origin)',
        'commercial_invoice' => '상업송장 (Commercial Invoice)',
        'customs' => '통관서류 (Customs Document)',
        'insurance' => '보험증권 (Insurance Certificate)',
        'other' => '기타 서류'
    ];
}

function displayDocumentUploadSection($customer_id) {
    $containers = getCustomerContainerList($customer_id);
    $documents = getCustomerUploadedDocuments($customer_id);
    $docTypes = getDocumentTypeOptions();
    ob_start();
    ?>

    <!-- 서류 관리 통합 섹션 (하나의 큰 박스) -->
    <section style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 2rem 0; border: 1px solid #e5e7eb;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <!-- 헤더 -->
            <div style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; text-align: center;">
                <h2 style="color: #1e40af; font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem;">
                    서류 등록
                </h2>
                <p style="color: #6b7280; font-size: 1rem; margin: 0;">컨테이너 관련 서류를 업로드하고 관리할 수 있습니다</p>
            </div>

            <!-- 업로드 결과 메시지 -->
            <?php if (isset($_SESSION['upload_message'])): ?>
                <div style="padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; <?= $_SESSION['upload_status'] === 'success' ? 'background: #d1fae5; color: #065f46; border: 1px solid #10b981;' : 'background: #fee2e2; color: #991b1b; border: 1px solid #ef4444;' ?>">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas <?= $_SESSION['upload_status'] === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle' ?>" style="font-size: 1.25rem;"></i>
                        <span style="font-weight: 500;"><?= htmlspecialchars($_SESSION['upload_message']) ?></span>
                    </div>
                </div>
                <?php
                unset($_SESSION['upload_message']);
                unset($_SESSION['upload_status']);
                ?>
            <?php endif; ?>

            <!-- 통합된 컨텐츠 -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
                <!-- 서류 업로드 폼 -->
                <div style="padding-bottom: 2rem; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="color: #374151; font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-plus-circle" style="color: #10b981;"></i>
                        서류 업로드
                    </h3>

                    <form id="documentUploadForm" enctype="multipart/form-data" method="POST" action="document_upload_process.php" style="display: grid; gap: 1.5rem;">
                        <!-- 파일 선택 -->
                        <div>
                            <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                파일 선택 <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="file"
                                   name="document_file"
                                   id="document_file"
                                   required
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"
                                   style="width: 100%; padding: 0.75rem; border: 2px dashed #d1d5db; border-radius: 6px; font-size: 0.9rem; cursor: pointer; background: #f9fafb;"
                                   onchange="updateFileName(this)">
                            <small style="color: #6b7280; font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                                <i class="fas fa-info-circle"></i> 허용 형식: PDF, JPG, PNG, DOC, DOCX, XLS, XLSX (최대 10MB)
                            </small>
                            <div id="fileName" style="margin-top: 0.5rem; color: #2563eb; font-size: 0.9rem; font-weight: 500;"></div>
                        </div>

                        <!-- 버튼 -->
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="reset"
                                    style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: background 0.2s;">
                                <i class="fas fa-redo"></i> 초기화
                            </button>
                            <button type="submit"
                                    style="padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: background 0.2s;">
                                <i class="fas fa-upload"></i> 업로드
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 업로드된 서류 목록 -->
                <div style="padding-top: 1rem;">
                    <h3 style="color: #374151; font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-list" style="color: #8b5cf6;"></i>
                        업로드된 서류 목록
                        <span style="background: #e0e7ff; color: #4f46e5; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; margin-left: auto;">
                            총 <?= count($documents) ?>개
                        </span>
                    </h3>

                    <?php if (empty($documents)): ?>
                        <div style="text-align: center; padding: 3rem 1rem; color: #9ca3af; background: #f9fafb; border-radius: 8px; border: 1px dashed #d1d5db;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p style="margin: 0; font-size: 0.95rem;">업로드된 서류가 없습니다</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">위의 폼을 사용하여 서류를 업로드해주세요</p>
                        </div>
                    <?php else: ?>
                        <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">서류 정보</th>
                                        <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">파일 크기</th>
                                        <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">업로드 날짜</th>
                                        <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; width: 150px;">다운로드</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($documents as $doc): ?>
                                        <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;"
                                            onmouseover="this.style.background='#f9fafb'"
                                            onmouseout="this.style.background='white'">
                                            <td style="padding: 0.75rem;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <i class="fas fa-file-alt" style="color: #6b7280;"></i>
                                                    <div>
                                                        <div style="color: #111827; font-weight: 500; margin-bottom: 0.25rem;">
                                                            <?= htmlspecialchars($doc['original_name']) ?>
                                                        </div>
                                                        <div style="color: #6b7280; font-size: 0.8rem;">
                                                            저장파일명: <?= htmlspecialchars($doc['file_name']) ?>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center; color: #6b7280;">
                                                <?= number_format($doc['file_size'] / 1024, 1) ?> KB
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center; color: #6b7280;">
                                                <?= htmlspecialchars($doc['upload_date']) ?>
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center;">
                                                <a href="download.php?doc_id=<?= $doc['doc_id'] ?>"
                                                   style="padding: 0.5rem 0.75rem; background: #10b981; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8rem; transition: background 0.2s; display: inline-block;"
                                                   title="다운로드">
                                                    <i class="fas fa-download"></i> 다운로드
                                                </a>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </section>

    <style>
        /* 버튼 호버 효과 */
        button[type="reset"]:hover {
            background: #4b5563 !important;
        }
        button[type="submit"]:hover {
            background: #1d4ed8 !important;
        }

        /* 다운로드 버튼 호버 */
        a[href*="download.php"]:hover {
            background: #059669 !important;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            section {
                padding: 1.5rem !important;
                margin: 1rem 0 !important;
            }
            #documentUploadForm {
                grid-template-columns: 1fr !important;
            }
            table {
                font-size: 0.8rem !important;
            }
            th, td {
                padding: 0.5rem !important;
            }
            h2 {
                font-size: 1.25rem !important;
            }
            h3 {
                font-size: 1rem !important;
            }
        }
    </style>

    <script>
        function updateFileName(input) {
            const fileNameDiv = document.getElementById('fileName');
            if (input.files && input.files[0]) {
                fileNameDiv.innerHTML = '<i class="fas fa-check-circle"></i> 선택된 파일: ' + input.files[0].name;
            } else {
                fileNameDiv.innerHTML = '';
            }
        }


        // 폼 제출 시 로딩 표시
        document.getElementById('documentUploadForm').addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 업로드 중...';
        });
    </script>

    <?php
    return ob_get_clean();
}
?>
