<?php
/**
 * 업로드 기능 테스트 및 디버깅
 * 인코딩: UTF-8
 */
session_start();
header('Content-Type: text/html; charset=utf-8');

require_once 'config.php';
require_once 'customer_document_upload_module.php';

echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>업로드 테스트</title>";
echo "<style>body{font-family:Arial,sans-serif;margin:20px;} .error{color:red;} .success{color:green;} .info{color:blue;} table{border-collapse:collapse;margin:10px 0;} td,th{border:1px solid #ddd;padding:8px;text-align:left;}</style>";
echo "</head><body>";

echo "<h2>서류 업로드 시스템 진단</h2>";

// 1. 데이터베이스 연결 확인
echo "<h3>1. 데이터베이스 연결 확인</h3>";
if ($pdo) {
    echo "<p class='success'>✓ 데이터베이스 연결 성공</p>";

    // 테이블 존재 확인
    try {
        $stmt = $pdo->query("SHOW TABLES LIKE 'customer_documents'");
        $table_exists = $stmt->fetch();

        if ($table_exists) {
            echo "<p class='success'>✓ customer_documents 테이블 존재</p>";

            // 테이블 구조 확인
            $stmt = $pdo->query("DESCRIBE customer_documents");
            $columns = $stmt->fetchAll(PDO::FETCH_ASSOC);
            echo "<p class='info'>테이블 컬럼:</p>";
            echo "<table><tr><th>필드</th><th>타입</th><th>Null</th><th>Key</th></tr>";
            foreach ($columns as $col) {
                echo "<tr><td>{$col['Field']}</td><td>{$col['Type']}</td><td>{$col['Null']}</td><td>{$col['Key']}</td></tr>";
            }
            echo "</table>";
        } else {
            echo "<p class='error'>✗ customer_documents 테이블이 존재하지 않습니다</p>";
            echo "<p>테이블을 생성하려면: <a href='setup_documents_table.php'>여기를 클릭</a></p>";
        }
    } catch (PDOException $e) {
        echo "<p class='error'>✗ 테이블 확인 오류: " . htmlspecialchars($e->getMessage()) . "</p>";
    }
} else {
    echo "<p class='error'>✗ 데이터베이스 연결 실패</p>";
}

// 2. 세션 확인
echo "<h3>2. 세션 확인</h3>";
if (isset($_SESSION['username'])) {
    echo "<p class='success'>✓ 로그인 사용자: " . htmlspecialchars($_SESSION['username']) . "</p>";
    $test_customer_id = $_SESSION['username'];
} else {
    echo "<p class='error'>✗ 로그인되지 않음</p>";
    echo "<p class='info'>테스트를 위해 임시 customer_id 사용: test_user</p>";
    $test_customer_id = 'test_user';
}

// 3. 폴더 권한 확인
echo "<h3>3. 업로드 폴더 확인</h3>";
$upload_base = __DIR__ . '/uploads/customer_documents';
echo "<p class='info'>업로드 기본 경로: " . htmlspecialchars($upload_base) . "</p>";

if (file_exists($upload_base)) {
    echo "<p class='success'>✓ 폴더 존재</p>";
    if (is_writable($upload_base)) {
        echo "<p class='success'>✓ 쓰기 권한 있음</p>";
    } else {
        echo "<p class='error'>✗ 쓰기 권한 없음</p>";
    }
} else {
    echo "<p class='error'>✗ 폴더 없음</p>";
    if (mkdir($upload_base, 0755, true)) {
        echo "<p class='success'>✓ 폴더 생성 성공</p>";
    } else {
        echo "<p class='error'>✗ 폴더 생성 실패</p>";
    }
}

// 4. PHP 업로드 설정 확인
echo "<h3>4. PHP 업로드 설정</h3>";
echo "<table>";
echo "<tr><td>upload_max_filesize</td><td>" . ini_get('upload_max_filesize') . "</td></tr>";
echo "<tr><td>post_max_size</td><td>" . ini_get('post_max_size') . "</td></tr>";
echo "<tr><td>max_file_uploads</td><td>" . ini_get('max_file_uploads') . "</td></tr>";
echo "<tr><td>file_uploads</td><td>" . (ini_get('file_uploads') ? '활성화' : '비활성화') . "</td></tr>";
echo "</table>";

// 5. 파일 업로드 테스트
echo "<h3>5. 파일 업로드 테스트</h3>";

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['test_file'])) {
    echo "<h4>업로드 시도 결과:</h4>";

    echo "<p class='info'>파일 정보:</p>";
    echo "<pre>";
    print_r($_FILES['test_file']);
    echo "</pre>";

    if (function_exists('uploadCustomerDocument')) {
        $result = uploadCustomerDocument($test_customer_id, $_FILES['test_file']);

        if ($result['success']) {
            echo "<p class='success'>✓ " . htmlspecialchars($result['message']) . "</p>";
            echo "<p class='info'>업로드된 파일 ID: " . $result['doc_id'] . "</p>";
        } else {
            echo "<p class='error'>✗ " . htmlspecialchars($result['message']) . "</p>";
        }
    } else {
        echo "<p class='error'>✗ uploadCustomerDocument 함수를 찾을 수 없습니다</p>";
    }
}

echo "<form method='POST' enctype='multipart/form-data' style='margin-top:20px; padding:20px; border:1px solid #ddd; background:#f9f9f9;'>";
echo "<h4>테스트 파일 업로드:</h4>";
echo "<input type='file' name='test_file' accept='.pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx' required>";
echo "<br><br>";
echo "<button type='submit' style='padding:10px 20px; background:#007bff; color:white; border:none; cursor:pointer;'>업로드 테스트</button>";
echo "</form>";

// 6. 업로드된 파일 목록
echo "<h3>6. 업로드된 파일 목록</h3>";
if ($pdo && isset($test_customer_id)) {
    try {
        $stmt = $pdo->prepare("SELECT * FROM customer_documents WHERE customer_id = ? ORDER BY upload_date DESC LIMIT 10");
        $stmt->execute([$test_customer_id]);
        $docs = $stmt->fetchAll(PDO::FETCH_ASSOC);

        if (!empty($docs)) {
            echo "<table>";
            echo "<tr><th>ID</th><th>파일명</th><th>크기</th><th>업로드일</th></tr>";
            foreach ($docs as $doc) {
                echo "<tr>";
                echo "<td>{$doc['doc_id']}</td>";
                echo "<td>" . htmlspecialchars($doc['original_name']) . "</td>";
                echo "<td>" . number_format($doc['file_size']) . " bytes</td>";
                echo "<td>{$doc['upload_date']}</td>";
                echo "</tr>";
            }
            echo "</table>";
        } else {
            echo "<p class='info'>업로드된 파일이 없습니다.</p>";
        }
    } catch (PDOException $e) {
        echo "<p class='error'>✗ 목록 조회 오류: " . htmlspecialchars($e->getMessage()) . "</p>";
    }
}

echo "<br><br><a href='index.php'>← 메인 페이지로 돌아가기</a>";
echo "</body></html>";
?>
