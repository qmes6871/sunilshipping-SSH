<?php
// ì„¸ì…˜ ì‹œì‘ (íŒŒì¼ ë§¨ ìœ„ì—ì„œ ì‹¤í–‰)
session_start();

// ì˜¤ë¥˜ í‘œì‹œ í™œì„±í™” (ë””ë²„ê¹…ìš©)
error_reporting(E_ALL);
ini_set('display_errors', 1);

// ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
define('DB_HOST', 'localhost');
define('DB_USER', 'sunilshipping');
define('DB_PASSWORD', 'sunil123!');
define('DB_NAME', 'sunilshipping');

try {
    $pdo = new PDO(
        "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4",
        DB_USER,
        DB_PASSWORD,
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        ]
    );
} catch (PDOException $e) {
    die("<h1>ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨</h1><p>" . $e->getMessage() . "</p>");
}

$ct_id = $_GET['ct_id'] ?? null;

if (!$ct_id) {
    die("<h1>ì˜¤ë¥˜</h1><p>ì»¨í…Œì´ë„ˆ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>");
}

// ì„¸ì…˜ì—ì„œ ë¡œê·¸ì¸í•œ ê³ ê° ID ê°€ì ¸ì˜¤ê¸°
$logged_customer_id = $_SESSION['username'] ?? null;

// ì»¨í…Œì´ë„ˆ ì •ë³´ ì¡°íšŒ - ê³ ê° IDê°€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ
try {
    $stmt = $pdo->prepare("SELECT * FROM container_tracking WHERE ct_id = ? AND customer_id = ?");
    $stmt->execute([$ct_id, $logged_customer_id]);
    $container = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$container) {
        die("<h1>ì˜¤ë¥˜</h1><p>ì»¨í…Œì´ë„ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p>");
    }
} catch (PDOException $e) {
    die("<h1>ì¿¼ë¦¬ ì˜¤ë¥˜</h1><p>" . $e->getMessage() . "</p>");
}

// ì„œë¥˜ ëª©ë¡ ìƒì„± (container_tracking í…Œì´ë¸”ì˜ document í•„ë“œë“¤ ì‚¬ìš©)
$documents = [];
$doc_fields = [
    'document_bl' => 'B/L',
    'document_invoice' => 'Invoice',
    'document_packing' => 'Packing List',
    'document_certificate' => 'Certificate',
    'document_other' => 'Other Documents'
];

foreach ($doc_fields as $field => $label) {
    if (!empty($container[$field])) {
        $documents[] = [
            'doc_type' => $label,
            'file_name' => $container[$field],
            'file_path' => '../uploads/tracing/documents/' . $container[$field],
            'upload_date' => $container['documents_updated_at'] ?? date('Y-m-d H:i')
        ];
    }
}

// ì„œë¥˜ íƒ€ì… í…ìŠ¤íŠ¸ ë³€í™˜
function getDocumentTypeText($doc_type) {
    return $doc_type;
}

// ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
function getTrackingStatusText($status) {
    $statusTexts = [
        'preparing' => 'ì¤€ë¹„ì¤‘',
        'active' => 'ìš´ì†¡ì¤‘',
        'shipping' => 'ìš´ì†¡ì¤‘',
        'completed' => 'ì™„ë£Œ',
        'delayed' => 'ì§€ì—°',
        'cancelled' => 'ì·¨ì†Œ'
    ];
    return $statusTexts[$status] ?? $status;
}
?>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¨í…Œì´ë„ˆ ìƒì„¸ ì •ë³´ - <?= htmlspecialchars($container['cntr_no']) ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #fff;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .back-btn {
            background: #555;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
        }

        .back-btn:hover {
            background: #333;
        }

        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .info-item {
            padding: 12px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 15px;
            font-weight: 500;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 13px;
            border: 1px solid #ddd;
        }

        .status-active { background: #f0f0f0; color: #333; }
        .status-shipped { background: #f0f0f0; color: #333; }
        .status-delayed { background: #f0f0f0; color: #333; }
        .status-preparing { background: #f0f0f0; color: #333; }
        .status-completed { background: #f0f0f0; color: #333; }

        .doc-list {
            display: grid;
            gap: 10px;
        }

        .doc-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
        }

        .doc-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .doc-type-badge {
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            border: 1px solid #ccc;
            background: #f5f5f5;
            color: #555;
        }

        .doc-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .doc-meta {
            font-size: 12px;
            color: #777;
            margin-top: 3px;
        }

        .btn-download {
            padding: 6px 14px;
            background: #555;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
        }

        .btn-download:hover {
            background: #333;
        }

        .empty-docs {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ ì»¨í…Œì´ë„ˆ ìƒì„¸ ì •ë³´</h1>
            <a href="index.php" class="back-btn">â† ëª©ë¡ìœ¼ë¡œ</a>
        </div>

        <!-- ì»¨í…Œì´ë„ˆ ì •ë³´ -->
        <div class="section">
            <h2 class="section-title">ê¸°ë³¸ ì •ë³´</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">ì»¨í…Œì´ë„ˆ ë²ˆí˜¸</div>
                    <div class="info-value" style="font-family: 'Courier New', monospace;">
                        <?= htmlspecialchars($container['cntr_no'] ?? '-') ?>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">êµ¬ë§¤ì</div>
                    <div class="info-value"><?= htmlspecialchars($container['buyer'] ?? '-') ?></div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì¶œë°œí•­</div>
                    <div class="info-value"><?= htmlspecialchars($container['port_1'] ?? '-') ?></div>
                </div>
                <div class="info-item">
                    <div class="info-label">ë„ì°©í•­</div>
                    <div class="info-value"><?= htmlspecialchars($container['port_2'] ?? '-') ?></div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì¶œë°œ ì˜ˆì •ì¼</div>
                    <div class="info-value"><?= htmlspecialchars($container['etd'] ?? '-') ?></div>
                </div>
                <div class="info-item">
                    <div class="info-label">ë„ì°© ì˜ˆì •ì¼</div>
                    <div class="info-value"><?= htmlspecialchars($container['eta'] ?? '-') ?></div>
                </div>
                <div class="info-item">
                    <div class="info-label">ê¸ˆì•¡</div>
                    <div class="info-value">$<?= number_format($container['amount'] ?? 0) ?></div>
                </div>
                <div class="info-item">
                    <div class="info-label">ìƒíƒœ</div>
                    <div class="info-value">
                        <span class="status-badge status-<?= $container['status'] ?? 'active' ?>">
                            <?= getTrackingStatusText($container['status'] ?? 'active') ?>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„œë¥˜ ëª©ë¡ -->
        <div class="section">
            <h2 class="section-title">ğŸ“„ ì—…ë¡œë“œëœ ì„œë¥˜</h2>
            <?php if (empty($documents)): ?>
                <div class="empty-docs">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
                    <p style="font-size: 16px; font-weight: 500;">ì—…ë¡œë“œëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 14px; margin-top: 5px;">ê´€ë¦¬ìì—ê²Œ ì„œë¥˜ ì—…ë¡œë“œë¥¼ ìš”ì²­í•˜ì„¸ìš”.</p>
                </div>
            <?php else: ?>
                <div class="doc-list">
                    <?php foreach ($documents as $doc): ?>
                        <div class="doc-item">
                            <div class="doc-info">
                                <span class="doc-type-badge doc-type-<?= $doc['doc_type'] ?>">
                                    <?= getDocumentTypeText($doc['doc_type']) ?>
                                </span>
                                <div>
                                    <div class="doc-name"><?= htmlspecialchars($doc['file_name']) ?></div>
                                    <div class="doc-meta">
                                        ì—…ë¡œë“œ: <?= $doc['upload_date'] ?>
                                    </div>
                                </div>
                            </div>
                            <a href="<?= htmlspecialchars($doc['file_path']) ?>"
                               class="btn-download"
                               download>
                                â¬‡ ë‹¤ìš´ë¡œë“œ
                            </a>
                        </div>
                    <?php endforeach; ?>
                </div>
            <?php endif; ?>
        </div>

        <!-- ë””ë²„ê·¸ ì •ë³´ (ê°œë°œìš© - ë‚˜ì¤‘ì— ì œê±°) -->
        <div class="section" style="background: #ecf0f1;">
            <h2 class="section-title" style="border-color: #95a5a6;">ë””ë²„ê·¸ ì •ë³´</h2>
            <p><strong>ì»¨í…Œì´ë„ˆ ID:</strong> <?= htmlspecialchars($ct_id) ?></p>
            <p><strong>ì„œë¥˜ ê°œìˆ˜:</strong> <?= count($documents) ?>ê°œ</p>
            <p><strong>ë°ì´í„°ë² ì´ìŠ¤:</strong> ì—°ê²°ë¨</p>
        </div>
    </div>
</body>
</html>
